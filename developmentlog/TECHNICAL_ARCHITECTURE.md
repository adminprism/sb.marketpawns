# Техническая архитектура проекта Market Pawns

## Общая архитектура

Проект Market Pawns построен по классической схеме веб-приложения с разделением на клиентскую и серверную части:

```
+-------------------+     +-------------------+     +-------------------+
|                   |     |                   |     |                   |
|   Client Browser  | <-> |   PHP Backend    | <-> |   Data Sources    |
|                   |     |                   |     |                   |
+-------------------+     +-------------------+     +-------------------+
```

## Компоненты системы

### Клиентская часть (Frontend)

#### HTML/CSS
- Основной интерфейс пользователя определен в `index.php`
- Стили определены в директории `css/`
- Адаптивный дизайн с поддержкой мобильных устройств

#### JavaScript (директория `js/`)
- **main.js** - основная логика клиентской части, обработка событий, инициализация
- **drawModels.js** - отрисовка моделей и графиков на холсте Canvas
- **functions.js** - вспомогательные функции
- **scroll-handler.js** - обработка прокрутки графиков
- **scroll-optimizer.js** - оптимизация производительности при прокрутке
- **landscape-optimizer.js** - оптимизация отображения в ландшафтном режиме
- **trade_emulator.js** - эмуляция торговых операций
- **moving_box_css.js** - работа с перемещаемыми элементами UI

### Серверная часть (Backend)

#### Основные PHP-файлы
- **index.php** - главный файл, генерирующий интерфейс пользователя
- **calc_controls.php** - обработка запросов на расчет параметров
- **build_models_A1.php** - построение моделей по алгоритму A1
- **build_models_A2.php** - построение моделей по алгоритму A2
- **src/build_models_common.php** - общие функции для построения моделей

#### Вспомогательные PHP-файлы
- **get_candles.php** - получение данных свечей из источников
- **get_fragment.php** - получение фрагментов данных для отображения
- **define_tokens.php** - определение токенов для API и безопасности
- **helper.php** - вспомогательные функции
- **save2csv.php** - сохранение данных в CSV-формате

#### Компоненты для включения
- **includes/config.php** - конфигурационные параметры
- **includes/header.php** - общий заголовок страниц
- **includes/footer.php** - общий футер страниц

### Источники данных

Проект поддерживает работу с различными источниками данных:
1. **FOREX (Finam)** - получение данных с серверов Finam
2. **Alpari** - получение данных от брокера Alpari
3. **MySQL** - локальная база данных для хранения исторических данных

## Потоки данных

### Получение данных графиков

```
+----------------+    +-----------------+    +----------------+
|                |    |                 |    |                |
| User Interface | -> | get_candles.php | -> | Data Sources  |
|                |    |                 |    |                |
+----------------+    +-----------------+    +----------------+
        ^                     |
        |                     v
        |              +----------------+
        |              |                |
        +------------- |    main.js     |
                       |                |
                       +----------------+
```

### Расчет и построение моделей

```
+----------------+    +-------------------+    +----------------+
|                |    |                   |    |                |
| User Interface | -> | build_models_A*.php | <- | Graphics Data |
|                |    |                   |    |                |
+----------------+    +-------------------+    +----------------+
        ^                     |
        |                     v
        |              +----------------+
        |              |                |
        +------------- |    main.js     |
                       |                |
                       +----------------+
```

## Ключевые алгоритмы

### Основные функции построения моделей

1. **Идентификация ключевых точек**
   - Определение точек t1, t2, t3, t4, t5 на свечных графиках
   - Расчет дополнительных точек t2', t3', t5' и т.д.

2. **Анализ отношений между точками**
   - Определение углов и расстояний
   - Расчет пропорций Фибоначчи
   - Идентификация паттернов

3. **Классификация моделей**
   - Группировка моделей по типам
   - Расчет вероятностей развития сценариев
   - Определение ключевых уровней

## Система хранения

### Файловая система
- **logs/** - логи работы приложения
- **saved_charts/** - сохраненные графики
- **big_saves/** и **fibo_big_saves/** - большие наборы данных
- **infobase/** - информационная база для моделей

### База данных
Используется для хранения:
- Исторических данных свечей
- Рассчитанных моделей
- Пользовательских настроек

## Безопасность

- Использование токенов безопасности для API-запросов (define_tokens.php)
- Управление доступом к файлам через .htaccess
- Логирование действий пользователей (login_log.php)

## Производительность

### Оптимизация клиентской части
- Управление размером Canvas в зависимости от устройства
- Оптимизация отрисовки при прокрутке и масштабировании
- Дебаунсинг для обработчиков событий

### Оптимизация серверной части
- Кэширование данных свечей
- Параллельные вычисления для расчета моделей
- Контроль использования памяти (checkMemorySize.php)

## Расширяемость

Проект спроектирован с учетом возможности:
- Добавления новых источников данных
- Внедрения новых алгоритмов анализа
- Расширения пользовательского интерфейса 